import{j as e,r as u,s as b}from"./index-C7G52Pl0.js";import{D as C}from"./DashboardLayout-BvYMyTkM.js";import{S as T}from"./search-Rqr5aH3r.js";import{P as k}from"./package-DupdcTls.js";import{A as M}from"./arrow-left-Crwr5rsD.js";import{c as $}from"./createLucideIcon-BK9ndVRo.js";import{C as L}from"./shield-check-DG8ZUOrZ.js";import{T as D}from"./Textarea-CO9hTvsh.js";import{S as U}from"./send-BlwoUKNF.js";import{M as E}from"./star-C80gymXW.js";import"./Logo-DmsMbJO2.js";import"./x-B7cmv6PP.js";import"./house-D2YIMOjc.js";import"./users-BmFRYmpR.js";import"./file-check-CHEU1kxb.js";import"./circle-question-mark-DtC5Y68d.js";import"./message-circle-CLbYCCGy.js";import"./file-text-XKYnme41.js";import"./user-CwMqLLM3.js";import"./BackgroundArt-Ct9Pe-Iv.js";/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]],z=$("check-check",I),O=({conversations:s=[],selectedChat:n,onSelectChat:a,searchQuery:o,onSearchChange:x,loading:h})=>{const l=t=>{const i=t.other_party||t.other_user;return i?`${i.first_name||""} ${i.last_name||""}`.trim()||i.email||"User":"Unknown User"},m=t=>(t||"U").split(" ").map(i=>i[0]).join("").toUpperCase().slice(0,2),c=t=>Array.isArray(t.last_message)&&t.last_message.length>0?t.last_message[0]:t.last_message||null,f=t=>t.product?t.product.name:t.context_type==="order"?`Order #${t.order_id}`:"Inquiry",v=t=>{const i=c(t);return i?i.attachment_url||i.is_file||i.is_image?"Sent an attachment":i.message||"No messages yet":"Started a conversation"},S=t=>{const i=c(t);if(!i)return"";const g=new Date(i.created_at),d=new Date-g,r=Math.floor(d/(1e3*60*60*24));return r===0?g.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):r===1?"Yesterday":r<7?g.toLocaleDateString([],{weekday:"short"}):g.toLocaleDateString([],{month:"short",day:"numeric"})},y=(Array.isArray(s)?s:[]).filter(t=>{const i=l(t).toLowerCase(),g=f(t).toLowerCase(),p=(o||"").toLowerCase();return i.includes(p)||g.includes(p)});return e.jsxs("div",{className:"flex flex-col h-full w-full",children:[e.jsx("div",{className:"p-4 border-b border-gray-100 bg-white sticky top-0 z-10",children:e.jsxs("div",{className:"relative",children:[e.jsx(T,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search messages...",value:o,onChange:t=>x(t.target.value),className:"w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 transition-all"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto w-full",children:h?e.jsxs("div",{className:"flex flex-col items-center justify-center h-48 space-y-3",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-brand-600"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Loading chats..."})]}):y.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full min-h-[200px] text-gray-500 px-6 text-center",children:[e.jsx("p",{className:"text-lg font-medium text-gray-400 mb-1",children:"No messages"}),e.jsx("p",{className:"text-sm",children:"Your conversation list is empty."})]}):e.jsx("div",{className:"divide-y divide-gray-50",children:y.map(t=>{const i=n?.id===t.id,g=l(t),p=f(t),d=m(g),r=(t.unread_count||0)>0;return e.jsx("button",{onClick:()=>a(t),className:`w-full p-4 text-left transition-all hover:bg-gray-50 ${i?"bg-brand-50/60 hover:bg-brand-50":""}`,children:e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"relative shrink-0",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-brand-100 to-brand-200 flex items-center justify-center text-brand-700 font-semibold text-sm border-2 border-white shadow-sm",children:d}),r&&e.jsx("span",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start mb-0.5",children:[e.jsx("h3",{className:`font-semibold text-sm truncate pr-2 ${r?"text-gray-900":"text-gray-700"}`,children:g}),e.jsx("span",{className:`text-[10px] whitespace-nowrap ${r?"text-brand-600 font-medium":"text-gray-400"}`,children:S(t)})]}),e.jsx("p",{className:`text-xs truncate mb-1.5 ${r?"text-gray-900 font-medium":"text-gray-500"}`,children:t.is_typing?e.jsx("span",{className:"text-brand-600 animate-pulse",children:"Typing..."}):v(t)}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-[10px] text-gray-500 flex items-center gap-1 bg-gray-100 px-1.5 py-0.5 rounded-md max-w-[80%] truncate",children:[e.jsx(k,{className:"w-3 h-3 text-gray-400"}),p]}),r&&e.jsx("span",{className:"bg-brand-500 text-white text-[10px] font-bold h-4 min-w-[1rem] px-1 rounded-full flex items-center justify-center",children:t.unread_count})]})]})]})},t.id)})})})]})},B=({conversation:s,onBack:n})=>{const a=()=>{const m=s.other_party||s.other_user;return m?`${m.first_name||""} ${m.last_name||""}`.trim()||m.email||"User":"Unknown User"},o=m=>(m||"U").split(" ").map(c=>c[0]).join("").toUpperCase().slice(0,2),x=a(),h=o(x),l=s.product?s.product.name:s.context_type==="order"?`Order #${s.order_id}`:"Inquiry";return e.jsx("div",{className:"p-3 md:p-4 border-b border-gray-200 bg-white shadow-sm z-20",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:n,className:"p-1 -ml-1 rounded-full hover:bg-gray-100 md:hidden text-gray-600 focus:outline-none",children:e.jsx(M,{className:"w-5 h-5"})}),e.jsx("div",{className:"relative",children:e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center text-white font-semibold text-sm shadow-sm",children:h})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 text-sm md:text-base leading-tight",children:x}),e.jsx("div",{className:"flex items-center gap-2 text-xs",children:s.is_typing?e.jsx("span",{className:"text-brand-600 font-medium animate-pulse",children:"Typing..."}):e.jsx("span",{className:"text-gray-500 flex items-center gap-1",children:l})})]})]})})})},q=({messages:s,currentUserId:n})=>{const a=u.useRef(null),o=u.useMemo(()=>!s||!Array.isArray(s)?[]:[...s].sort((l,m)=>new Date(l.created_at)-new Date(m.created_at)),[s]),x=()=>{a.current?.scrollIntoView({behavior:"smooth"})};u.useEffect(()=>{x()},[o]);const h=l=>l?new Date(l).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}):"";return e.jsx("div",{className:"flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50",children:e.jsxs("div",{className:"space-y-4",children:[o.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400 mt-10",children:[e.jsx("p",{className:"text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-xs",children:"Say hello to start the conversation!"})]}):o.map((l,m)=>{const c=String(l.sender_id)===String(n)||String(l.user_id)===String(n);return e.jsx("div",{className:`flex ${c?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[75%] md:max-w-[60%] rounded-2xl px-4 py-2.5 shadow-sm ${c?"bg-brand-600 text-white rounded-tr-none":"bg-white text-gray-800 border border-gray-100 rounded-tl-none"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap leading-relaxed",children:l.message}),e.jsxs("div",{className:`flex items-center justify-end gap-1 mt-1 ${c?"text-white/80":"text-gray-400"}`,children:[e.jsx("span",{className:"text-[10px] min-w-[35px] text-right",children:h(l.created_at)}),c&&(l.is_read?e.jsx(z,{className:"w-3 h-3"}):e.jsx(L,{className:"w-3 h-3"}))]})]})},l.id||m)}),e.jsx("div",{ref:a})]})})},P=({onSendMessage:s,onTyping:n})=>{const[a,o]=u.useState(""),[x,h]=u.useState(!1),l=c=>{c.preventDefault(),a.trim()&&(s(a),o(""),h(!1),n?.(!1))},m=c=>{const f=c.target.value;o(f),f.trim()&&!x?(h(!0),n?.(!0)):!f.trim()&&x&&(h(!1),n?.(!1))};return e.jsx("div",{className:"p-4 border-t border-gray-200 bg-white",children:e.jsxs("form",{onSubmit:l,className:"flex items-end gap-3",children:[e.jsx("div",{className:"flex-1 relative",children:e.jsx(D,{value:a,onChange:m,placeholder:"Type your message...",rows:1,className:"pr-12 rounded-xl resize-none",onKeyDown:c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),l(c))}})}),e.jsx("button",{type:"submit",disabled:!a.trim(),className:"p-3 bg-brand-500 text-white rounded-xl hover:bg-brand-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(U,{className:"w-5 h-5"})})]})})},R=()=>e.jsx("div",{className:"flex-1 flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-24 h-24 bg-gradient-to-br from-brand-100 to-brand-200 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(E,{className:"w-12 h-12 text-brand-600"})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-gray-600",children:"Choose a chat from the list to start messaging"})]})}),w="https://agrimeetbackend.agrimeetconnect.com/api/v1",N=async s=>{if(!s.ok){const n=await s.json().catch(()=>({message:"An error occurred"}));throw new Error(n.message||n.error||"Request failed")}return s.json()},A={getConversations:async({unread_only:s=!1,context_type:n=null}={})=>{const a=b.getAccessToken();let o=`${w}/conversations`;const x=new URLSearchParams;s&&x.append("unread_only","true"),n&&x.append("context_type",n),x.toString()&&(o+=`?${x.toString()}`);const h=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json",Accept:"application/json"}});return N(h)},getMessages:async s=>{const n=b.getAccessToken(),a=await fetch(`${w}/conversations/${s}/messages`,{method:"GET",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json",Accept:"application/json"}});return N(a)},sendMessage:async(s,{message:n})=>{const a=b.getAccessToken(),o=await fetch(`${w}/conversations/${s}/messages`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({message:n})});return N(o)},getUnreadCount:async()=>{const s=b.getAccessToken(),n=await fetch(`${w}/messages/unread-count`,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json",Accept:"application/json"}});return N(n)},sendTypingIndicator:async(s,{is_typing:n})=>{const a=b.getAccessToken(),o=await fetch(`${w}/conversations/${s}/typing`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({is_typing:n})});return N(o)}},ce=()=>{const[s,n]=u.useState([]),[a,o]=u.useState(null),[x,h]=u.useState([]),[l,m]=u.useState(!0),[c,f]=u.useState(!1),[v,S]=u.useState(""),_=b.getUserData(),y=_?.data?.id||_?.id;u.useEffect(()=>{t()},[]),u.useEffect(()=>{a&&i(a.id)},[a]);const t=async()=>{try{m(!0);const d=await A.getConversations();let r=[];Array.isArray(d)?r=d:d?.data&&Array.isArray(d.data)?r=d.data:d?.data?.data&&Array.isArray(d.data.data)&&(r=d.data.data),n(r)}catch(d){console.error("Error fetching conversations:",d),n([])}finally{m(!1)}},i=async d=>{try{f(!0);const r=await A.getMessages(d);let j=[];Array.isArray(r)?j=r:r?.data&&Array.isArray(r.data)?j=r.data:r?.messages&&Array.isArray(r.messages)&&(j=r.messages),h(j)}catch(r){console.error(r)}finally{f(!1)}},g=async d=>{if(a)try{const r={id:Date.now(),conversation_id:a.id,sender_id:y,user_id:y,message:d,created_at:new Date().toISOString(),is_read:!1};h(j=>[...j,r]),await A.sendMessage(a.id,{message:d}),i(a.id),t()}catch(r){console.error("Failed to send message",r)}},p=!!a;return e.jsxs(C,{children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Messages"}),e.jsx("p",{className:"text-gray-600 mt-2 mb-4",children:"Communicate and stay connected with your business customers"})]}),e.jsxs("div",{className:"flex h-[calc(100vh-7rem)] bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:`
                    w-full md:w-80 border-r border-gray-200 bg-white flex flex-col h-full
                    ${p?"hidden md:flex":"flex"}
                `,children:e.jsx(O,{conversations:s,selectedChat:a,onSelectChat:o,searchQuery:v,onSearchChange:S,loading:l})}),e.jsx("div",{className:`
                    flex-1 bg-gray-50 flex-col h-full relative
                    ${p?"flex":"hidden md:flex"}
                `,children:a?e.jsxs(e.Fragment,{children:[e.jsx(B,{conversation:a,onBack:()=>o(null)}),e.jsx("div",{className:"flex-1 overflow-y-auto relative w-full",children:c?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-50 z-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-brand-600 mx-auto"}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Loading..."})]})}):e.jsx(q,{messages:x,currentUserId:y})}),e.jsx(P,{onSendMessage:g,onTyping:()=>{}})]}):e.jsx(R,{})})]})]})};export{ce as default};
