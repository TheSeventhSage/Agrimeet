meta {
  name: Create and validate a new delivery address
  type: http
  seq: 3
}

post {
  url: {{baseUrl}}/buyer/delivery-addresses
  body: json
  auth: bearer
}

headers {
  Content-Type: application/json
  Accept: application/json
}

auth:bearer {
  token: {{bearerToken}}
}

body:json {
  {
    "recipient_name": "John Doe",
    "phone_number": "+234 801 234 5678",
    "address_line1": "123 Main Street",
    "address_city": "Lagos",
    "address_state": "Lagos",
    "address_country": "Nigeria",
    "address_line2": "Apt 4B",
    "address_postal_code": "100001",
    "latitude": 6.5244,
    "longitude": 3.3792,
    "is_default": true
  }
}

settings {
  encodeUrl: true
}

docs {
  Creates a new delivery address and validates it with Shipbubble shipping service. The address must pass Shipbubble validation before it can be used for orders. Returns validated address with Shipbubble address code. If marked as default, all other addresses are automatically set to non-default.
}

example {
  name: Delivery address created and validated successfully
  
  request: {
    url: {{baseUrl}}/buyer/delivery-addresses
    method: POST
    mode: json
    headers: {
      Content-Type: application/json
      Accept: application/json
      Authorization: Bearer <token>
    }
  
    body:json: {
      {
        "recipient_name": "John Doe",
        "phone_number": "+234 801 234 5678",
        "address_line1": "123 Main Street",
        "address_city": "Lagos",
        "address_state": "Lagos",
        "address_country": "Nigeria",
        "address_line2": "Apt 4B",
        "address_postal_code": "100001",
        "latitude": 6.5244,
        "longitude": 3.3792,
        "is_default": true
      }
    }
  }
  
  response: {
    headers: {
      Content-Type: application/json
    }
  
    status: {
      code: Created
      text: 201
    }
  
    body: {
      type: json
      content: '''
        {
          "data": {
            "id": 15,
            "user_id": 89,
            "full_name": "John Doe",
            "phone_number": "+234 801 234 5678",
            "address_line1": "123 Main Street",
            "address_line2": "Apt 4B",
            "address_city": "Lagos",
            "address_state": "Lagos",
            "address_postal_code": "100001",
            "address_country": "Nigeria",
            "is_default": true,
            "shipbubble_address_code": "ADDR_ABC123",
            "is_validated": true,
            "created": "2025-09-15T10:30:00Z"
          }
        }
      '''
    }
  }
}

example {
  name: Unauthenticated
  
  request: {
    url: {{baseUrl}}/buyer/delivery-addresses
    method: POST
    mode: json
    headers: {
      Content-Type: application/json
      Accept: application/json
      Authorization: Bearer <token>
    }
  
    body:json: {
      {
        "recipient_name": "John Doe",
        "phone_number": "+234 801 234 5678",
        "address_line1": "123 Main Street",
        "address_city": "Lagos",
        "address_state": "Lagos",
        "address_country": "Nigeria",
        "address_line2": "Apt 4B",
        "address_postal_code": "100001",
        "latitude": 6.5244,
        "longitude": 3.3792,
        "is_default": true
      }
    }
  }
  
  response: {
    headers: {
      Content-Type: application/json
    }
  
    status: {
      code: Unauthorized
      text: 401
    }
  
    body: {
      type: json
      content: '''
        {
          "error": "Unauthenticated."
        }
      '''
    }
  }
}

example {
  name: Validation error or address cannot be validated by Shipbubble
  
  request: {
    url: {{baseUrl}}/buyer/delivery-addresses
    method: POST
    mode: json
    headers: {
      Content-Type: application/json
      Accept: application/json
      Authorization: Bearer <token>
    }
  
    body:json: {
      {
        "recipient_name": "John Doe",
        "phone_number": "+234 801 234 5678",
        "address_line1": "123 Main Street",
        "address_city": "Lagos",
        "address_state": "Lagos",
        "address_country": "Nigeria",
        "address_line2": "Apt 4B",
        "address_postal_code": "100001",
        "latitude": 6.5244,
        "longitude": 3.3792,
        "is_default": true
      }
    }
  }
  
  response: {
    headers: {
      Content-Type: application/json
    }
  
    status: {
      code: Unprocessable Entity (WebDAV) (RFC 4918)
      text: 422
    }
  
    body: {
      type: json
      content: '''
        {
          "error": "Unable to validate delivery address",
          "message": "The given data was invalid.",
          "errors": {
            "phone_number": [
              "The phone number field is required.",
              "The phone number field is required."
            ]
          }
        }
      '''
    }
  }
}
